# Инструкция по настройке Email-уведомлений

## Общая информация

Система теперь автоматически отправляет email-уведомления:

1. **Уведомление об очереди** - когда студент становится в очередь
2. **Уведомление об одобрении** - когда его очередь дошла и слот освободился
3. Будущая функция: уведомление об отмене

## Шаг 1: Установка зависимостей

Убедитесь, что Flask-Mail установлен:

```bash
pip install -r requirements.txt
```

Или напрямую:

```bash
pip install Flask-Mail
```

## Шаг 2: Настройка Gmail

### Способ 1: Использование Google App Password (Рекомендуется)

1. Перейдите на https://myaccount.google.com/
2. Слева выберите **Безопасность**
3. Включите **Двухэтапную аутентификацию** (если она не включена)
4. Найдите в "Безопасность" пункт **Пароли приложений** (появится только после включения 2FA)
5. Выберите:
   - Приложение: Mail
   - Устройство: Windows/Mac/Linux
6. Google создаст 16-символный пароль - скопируйте его

### Способ 2: Использование обычного пароля Gmail

Если вы не хотите использовать App Password:

1. Перейдите на https://myaccount.google.com/security
2. Отключите "Проверка в два шага" (не рекомендуется)
3. Используйте свой обычный пароль Gmail

## Шаг 3: Конфигурация `.env` файла

1. Откройте файл `.env` в корне проекта
2. Заполните переменные:

```env
MAIL_SERVER=smtp.gmail.com
MAIL_PORT=587
MAIL_USE_TLS=True
MAIL_USERNAME=your-email@gmail.com
MAIL_PASSWORD=xxxx xxxx xxxx xxxx
MAIL_DEFAULT_SENDER=noreply@booking-system.com
```

**Важно**: Пароль приложения содержит пробелы - это нормально!

## Шаг 4: Использование других SMTP серверов

Если вы не используете Gmail, измените параметры:

### Яндекс.Почта

```env
MAIL_SERVER=smtp.yandex.ru
MAIL_PORT=465
MAIL_USE_TLS=False
MAIL_USERNAME=your-email@yandex.ru
MAIL_PASSWORD=your-password
```

### Outlook/Hotmail

```env
MAIL_SERVER=smtp-mail.outlook.com
MAIL_PORT=587
MAIL_USE_TLS=True
MAIL_USERNAME=your-email@outlook.com
MAIL_PASSWORD=your-password
```

### Собственный SMTP сервер

```env
MAIL_SERVER=your-smtp-server.com
MAIL_PORT=587
MAIL_USE_TLS=True
MAIL_USERNAME=your-username
MAIL_PASSWORD=your-password
```

## Шаг 5: Проверка работы

Запустите сервер:

```bash
python run.py
```

Проверьте логи в консоли при отправке письма. Если есть ошибка, вы увидите сообщение типа:

```
Ошибка при отправке email: [причина ошибки]
```

## Как работает отправка email?

1. **Асинхронная отправка**: Письма отправляются в отдельном потоке, чтобы не блокировать пользовательский запрос
2. **Красивое оформление**: HTML письма с логотипом и стилизацией
3. **Обработка ошибок**: Если email не отправляется, система продолжит работу нормально

## Функции отправки

### `send_queue_notification_email()`

Отправляется, когда студент добавляется в очередь

**Содержит:**

- Номер аудитории
- Дату и время
- Позицию в очереди
- Информацию о том, что будет отправлено уведомление

### `send_queue_approved_email()`

Отправляется, когда слот освободился и студент может забронировать

**Содержит:**

- Номер аудитории
- Дату и время
- Уведомление действовать в течение 1 часа

### `send_booking_cancelled_email()`

Отправляется при отмене бронирования

## Тестирование без SMTP сервера

Для локального тестирования без реальной отправки email, отредактируйте `config.py`:

```python
# Режим отладки (не отправляет реальные письма)
MAIL_BACKEND = 'testing'
```

## Решение проблем

### "Authentication failed" или "535 5.7.8 Error"

- Проверьте учетные данные в `.env`
- Убедитесь, что вы используете 16-символный App Password, а не обычный пароль
- Если используете Gmail без 2FA, разрешите "Небезопасные приложения"

### "Connection refused" или "Connection timeout"

- Проверьте правильность MAIL_SERVER
- Убедитесь, что MAIL_PORT соответствует серверу (587 для TLS, 465 для SSL)
- Проверьте интернет-соединение

### "SSL: CERTIFICATE_VERIFY_FAILED"

Это может произойти в Windows. Попробуйте установить сертификаты:

```bash
/Applications/Python\ 3.11/Install\ Certificates.command
```

### Письма приходят в SPAM

- Добавьте отправителя в контакты
- Проверьте MAIL_DEFAULT_SENDER - используйте реальный домен компании
- Убедитесь, что письмо содержит корректный From header

## Контроль отправки через код

В файле `app/email.py` можно отключить/включить отправку:

```python
# Отключить отправку (для отладки)
def send_email(subject, recipients, text_body, html_body=None):
    print(f"Email not sent: {subject} to {recipients}")
    return

# Или использовать флаг
DEBUG_EMAIL = True
if DEBUG_EMAIL:
    print(f"[DEBUG] Email: {subject}")
else:
    # реальная отправка
    ...
```

## Готово!

Теперь при каждом действии с очередью система будет отправлять email-уведомления студентам.
