{% extends "base.html" %} {% block content %}
<div class="container">
  <div class="row">
    <div class="col-md-12">
      <h1 class="text-white"><i class="fas fa-user"></i> Мой профиль</h1>

      <!-- Информация о пользователе -->
      <div class="card mb-4">
        <div class="card-header">
          <h5 class="mb-0"><i class="fas fa-id-card"></i> Информация о пользователе</h5>
        </div>
        <div class="card-body">
          <div class="row">
            <div class="col-md-6">
              <div class="user-info-item mb-3">
                <div class="d-flex align-items-center">
                  <div class="user-icon me-3">
                    <i class="fas fa-user-circle fa-2x text-primary"></i>
                  </div>
                  <div>
                    <h6 class="mb-0">{{ current_user.username }}</h6>
                    <small class="text-muted">{{ current_user.email }}</small>
                  </div>
                </div>
              </div>
              <p>
                <strong><i class="fas fa-id-badge me-2"></i>Роль:</strong>
                <span
                  class="badge {% if current_user.role == 'teacher' %}bg-success{% else %}bg-primary{% endif %}"
                >
                  {{ 'Преподаватель' if current_user.role == 'teacher' else 'Студент' }}
                </span>
              </p>
            </div>
            <div class="col-md-6">
              <p>
                <strong><i class="fas fa-calendar-plus me-2"></i>Дата регистрации:</strong> {{
                current_user.created_at.strftime('%d.%m.%Y') }}
              </p>
              <p>
                <strong><i class="fas fa-history me-2"></i>Статистика:</strong>
              </p>
              <div class="d-flex flex-wrap gap-2">
                <span class="badge bg-success">
                  <i class="fas fa-check-circle me-1"></i>
                  Одобрено: {{ bookings|selectattr('status', 'equalto', 'approved')|list|length }}
                </span>
                <span class="badge bg-warning">
                  <i class="fas fa-clock me-1"></i>
                  Ожидание: {{ bookings|selectattr('status', 'equalto', 'pending')|list|length }}
                </span>
                <span class="badge bg-info">
                  <i class="fas fa-calendar-day me-1"></i>
                  Сегодня: {{ bookings|selectattr('booking_date', 'equalto',
                  current_date)|list|length }}
                </span>
              </div>
            </div>
          </div>

          {% if current_user.role in ['teacher', 'admin'] %}
          <div class="mt-3">
            <a href="{{ url_for('main.admin_bookings') }}" class="btn btn-primary">
              <i class="fas fa-cog me-2"></i> Управление бронированиями
            </a>
          </div>
          {% endif %}
        </div>
      </div>

      <!-- Активные бронирования на сегодня -->
      {% set today_bookings = bookings|selectattr('booking_date', 'equalto', current_date)|list %}
      {% set active_today_bookings = today_bookings|selectattr('status', 'in', ['approved',
      'pending'])|list %} {% if active_today_bookings %}
      <div class="card mb-4">
        <div class="card-header">
          <h5 class="mb-0"><i class="fas fa-calendar-day"></i> Мои бронирования на сегодня</h5>
        </div>
        <div class="card-body">
          <div class="row">
            {% for booking in active_today_bookings %}
            <div class="col-md-6 col-lg-4 mb-3">
              <div
                class="card h-100 {% if booking.start_time <= now.time() and booking.end_time > now.time() %}border-success border-2 pulse-green{% endif %}"
              >
                <div class="card-header bg-transparent">
                  <div class="d-flex justify-content-between align-items-center">
                    <h6 class="mb-0">
                      <i class="fas fa-door-closed me-2"></i>
                      Аудитория {{ booking.classroom.room_number }}
                    </h6>
                    {% if booking.status == 'approved' %} {% if booking.start_time <= now.time() and
                    booking.end_time > now.time() %}
                    <span class="badge bg-success">
                      <i class="fas fa-play me-1"></i>Идет сейчас
                    </span>
                    {% elif booking.start_time > now.time() %}
                    <span class="badge bg-info"> <i class="fas fa-clock me-1"></i>Ожидание </span>
                    {% endif %} {% else %}
                    <span class="badge bg-warning">
                      <i class="fas fa-hourglass-half me-1"></i>На рассмотрении
                    </span>
                    {% endif %}
                  </div>
                </div>
                <div class="card-body">
                  <div class="booking-time mb-3">
                    <div class="text-center">
                      <div class="display-6 fw-bold">
                        {{ booking.start_time.strftime('%H:%M') }}
                      </div>
                      <small class="text-muted">начало</small>
                    </div>
                    <div class="text-center mx-2">
                      <i class="fas fa-arrow-right fa-lg text-muted"></i>
                    </div>
                    <div class="text-center">
                      <div class="display-6 fw-bold">{{ booking.end_time.strftime('%H:%M') }}</div>
                      <small class="text-muted">окончание</small>
                    </div>
                  </div>

                  <p class="mb-2">
                    <strong><i class="fas fa-bullseye me-2"></i>Цель:</strong> {{
                    booking.purpose|truncate(50) }}
                  </p>

                  {% if booking.status == 'approved' and booking.start_time <= now.time() and
                  booking.end_time > now.time() %}
                  <div class="progress mt-3" style="height: 10px">
                    {% set total_minutes = (booking.end_time.hour * 60 + booking.end_time.minute) -
                    (booking.start_time.hour * 60 + booking.start_time.minute) %} {% set
                    passed_minutes = (now.time().hour * 60 + now.time().minute) -
                    (booking.start_time.hour * 60 + booking.start_time.minute) %} {% set
                    progress_percentage = (passed_minutes / total_minutes * 100)|int if
                    passed_minutes > 0 else 0 %} {% if progress_percentage > 100 %}{% set
                    progress_percentage = 100 %}{% endif %} {% if progress_percentage < 0 %}{% set
                    progress_percentage = 0 %}{% endif %}

                    <div
                      class="progress-bar bg-success"
                      role="progressbar"
                      aria-valuenow="{{ progress_percentage }}"
                      aria-valuemin="0"
                      aria-valuemax="100"
                    ></div>
                  </div>
                  <small class="text-muted d-block mt-2 text-center">
                    <i class="fas fa-hourglass-half me-1"></i>
                    Пройдено: {{ progress_percentage }}% {% set remaining_minutes = total_minutes -
                    passed_minutes %} {% if remaining_minutes > 0 %} (осталось: {{ remaining_minutes
                    }} мин.) {% endif %}
                  </small>
                  {% endif %}
                </div>
                <div class="card-footer bg-transparent">
                  <div class="d-flex justify-content-between align-items-center">
                    <small class="text-muted">
                      <i class="fas fa-calendar me-1"></i>
                      {{ booking.booking_date.strftime('%d.%m.%Y') }}
                    </small>
                    {% if booking.booking_date >= current_date and booking.status in ['approved',
                    'pending'] %}
                    <a
                      href="{{ url_for('main.cancel_booking', booking_id=booking.id) }}"
                      class="btn btn-outline-danger btn-sm"
                      onclick="return confirm('Отменить это бронирование?')"
                    >
                      <i class="fas fa-times me-1"></i>Отменить
                    </a>
                    {% endif %}
                  </div>
                </div>
              </div>
            </div>
            {% endfor %}
          </div>
        </div>
      </div>
      {% endif %}

      <!-- Очередь ожидания -->
      {% if queue_entries %}
      <div class="card mb-4">
        <div class="card-header">
          <div class="d-flex justify-content-between align-items-center">
            <h5 class="mb-0"><i class="fas fa-hourglass-half"></i> Мои позиции в очереди</h5>
            <span class="badge bg-warning">{{ queue_entries|length }}</span>
          </div>
        </div>
        <div class="card-body">
          <div class="row">
            {% for queue in queue_entries %}
            <div class="col-md-6 col-lg-4 mb-3">
              <div class="card border-warning h-100">
                <div class="card-header bg-warning bg-opacity-10">
                  <div class="d-flex justify-content-between align-items-center">
                    <h6 class="mb-0">
                      <i class="fas fa-door-closed me-2"></i>
                      Аудитория {{ queue.classroom.room_number }}
                    </h6>
                    <span class="badge bg-warning">
                      <i class="fas fa-list me-1"></i>Позиция {{ queue.queue_position }}
                    </span>
                  </div>
                </div>
                <div class="card-body">
                  <p class="mb-2">
                    <strong><i class="fas fa-calendar me-2"></i>Дата:</strong>
                    {{ queue.booking_date.strftime('%d.%m.%Y') }}
                  </p>
                  <p class="mb-2">
                    <strong><i class="fas fa-clock me-2"></i>Время:</strong>
                    <span class="badge bg-light text-dark"
                      >{{ queue.start_time.strftime('%H:%M') }}</span
                    >
                    <i class="fas fa-arrow-right mx-1 text-muted"></i>
                    <span class="badge bg-light text-dark"
                      >{{ queue.end_time.strftime('%H:%M') }}</span
                    >
                  </p>
                  {% if queue.status == 'notified' %}
                  <div class="alert alert-success mb-3 py-2" role="alert">
                    <i class="fas fa-bell me-2"></i>
                    <strong>Вас уведомили!</strong> Слот освободился
                  </div>
                  {% endif %}
                  <small class="text-muted">
                    <i class="fas fa-info-circle me-1"></i>
                    Добавлено: {{ queue.created_at.strftime('%d.%m.%Y %H:%M') }}
                  </small>
                </div>
                <div class="card-footer bg-transparent">
                  <a
                    href="{{ url_for('main.remove_from_queue', queue_id=queue.id) }}"
                    class="btn btn-outline-danger btn-sm w-100"
                    onclick="return confirm('Удалить из очереди?')"
                  >
                    <i class="fas fa-times me-1"></i>Удалить из очереди
                  </a>
                </div>
              </div>
            </div>
            {% endfor %}
          </div>
        </div>
      </div>
      {% endif %}

      <!-- Все бронирования -->
      <div class="card">
        <div class="card-header">
          <div class="d-flex justify-content-between align-items-center">
            <h5 class="mb-0"><i class="fas fa-calendar-alt"></i> История всех бронирований</h5>
            <span class="badge bg-primary">{{ bookings|length }}</span>
          </div>
        </div>
        <div class="card-body">
          {% if bookings %}
          <div class="table-responsive">
            <table class="table table-hover">
              <thead>
                <tr>
                  <th>Аудитория</th>
                  <th>Дата</th>
                  <th>Время</th>
                  <th>Цель</th>
                  <th>Статус</th>
                  <th>Действия</th>
                </tr>
              </thead>
              <tbody>
                {% for booking in bookings %}
                <tr class="{% if booking.booking_date == current_date %}table-info{% endif %}">
                  <td>
                    <div class="d-flex align-items-center">
                      <div class="classroom-icon me-2">
                        <i class="fas fa-door-closed"></i>
                      </div>
                      <div>
                        <strong>Аудитория {{ booking.classroom.room_number }}</strong><br />
                        <small class="text-muted">
                          Вместимость: {{ booking.classroom.capacity }} чел. {% if
                          booking.classroom.has_projector %}
                          <i class="fas fa-video ms-2 text-info" title="Проектор"></i>
                          {% endif %} {% if booking.classroom.has_computers %}
                          <i class="fas fa-desktop ms-2 text-primary" title="Компьютеры"></i>
                          {% endif %}
                        </small>
                      </div>
                    </div>
                  </td>
                  <td>
                    {{ booking.booking_date.strftime('%d.%m.%Y') }} {% if booking.booking_date ==
                    current_date %}
                    <span class="badge bg-info ms-1">Сегодня</span>
                    {% endif %}
                  </td>
                  <td>
                    <div class="time-slot">
                      <span class="badge bg-light text-dark"
                        >{{ booking.start_time.strftime('%H:%M') }}</span
                      >
                      <i class="fas fa-arrow-right mx-1 text-muted"></i>
                      <span class="badge bg-light text-dark"
                        >{{ booking.end_time.strftime('%H:%M') }}</span
                      >
                    </div>
                  </td>
                  <td>
                    <div class="booking-purpose">
                      {{ booking.purpose|truncate(40) }} {% if booking.purpose|length > 40 %}
                      <a
                        href="#"
                        class="text-primary"
                        data-bs-toggle="tooltip"
                        title="{{ booking.purpose }}"
                      >
                        <i class="fas fa-info-circle"></i>
                      </a>
                      {% endif %}
                    </div>
                  </td>
                  <td>
                    {% if booking.status == 'approved' %} {% if booking.booking_date < current_date
                    or (booking.booking_date == current_date and booking.end_time < now.time()) %}
                    <span class="badge bg-secondary">
                      <i class="fas fa-check me-1"></i>Завершено
                    </span>
                    {% elif booking.start_time <= now.time() and booking.end_time > now.time() %}
                    <span class="badge bg-success"> <i class="fas fa-play me-1"></i>Активно </span>
                    {% else %}
                    <span class="badge bg-success">
                      <i class="fas fa-check me-1"></i>Одобрено
                    </span>
                    {% endif %} {% elif booking.status == 'pending' %}
                    <span class="badge bg-warning">
                      <i class="fas fa-clock me-1"></i>Ожидание
                    </span>
                    {% elif booking.status == 'completed' %}
                    <span class="badge bg-secondary">
                      <i class="fas fa-check me-1"></i>Завершено
                    </span>
                    {% else %}
                    <span class="badge bg-danger">
                      <i class="fas fa-times me-1"></i>Отклонено
                    </span>
                    {% endif %}
                  </td>
                  <td>
                    {% if booking.booking_date >= current_date and booking.status in ['approved',
                    'pending'] %}
                    <div class="btn-group btn-group-sm">
                      <a
                        href="{{ url_for('main.cancel_booking', booking_id=booking.id) }}"
                        class="btn btn-outline-danger"
                        onclick="return confirm('Отменить это бронирование?')"
                        data-bs-toggle="tooltip"
                        title="Отменить"
                      >
                        <i class="fas fa-times"></i>
                      </a>
                      {% if booking.status == 'pending' and current_user.role == 'teacher' %}
                      <a
                        href="{{ url_for('main.approve_booking', booking_id=booking.id) }}"
                        class="btn btn-outline-success"
                        data-bs-toggle="tooltip"
                        title="Одобрить"
                      >
                        <i class="fas fa-check"></i>
                      </a>
                      {% endif %}
                    </div>
                    {% else %}
                    <span class="text-muted">-</span>
                    {% endif %}
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>

          <!-- Фильтры для таблицы -->
          <div class="row mt-3">
            <div class="col-md-12">
              <div class="card">
                <div class="card-body py-2">
                  <div class="d-flex flex-wrap gap-2">
                    <button
                      class="btn btn-sm btn-outline-primary active filter-btn"
                      data-filter="all"
                    >
                      Все ({{ bookings|length }})
                    </button>
                    <button
                      class="btn btn-sm btn-outline-success filter-btn"
                      data-filter="approved"
                    >
                      Одобрено ({{ bookings|selectattr('status', 'equalto', 'approved')|list|length
                      }})
                    </button>
                    <button class="btn btn-sm btn-outline-warning filter-btn" data-filter="pending">
                      Ожидание ({{ bookings|selectattr('status', 'equalto', 'pending')|list|length
                      }})
                    </button>
                    <button
                      class="btn btn-sm btn-outline-secondary filter-btn"
                      data-filter="completed"
                    >
                      Завершено
                    </button>
                    <button class="btn btn-sm btn-outline-info filter-btn" data-filter="today">
                      Сегодня ({{ today_bookings|length }})
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </div>

          {% else %}
          <div class="text-center py-5">
            <div class="mb-3">
              <i class="fas fa-calendar-times fa-4x text-muted"></i>
            </div>
            <h4>У вас пока нет бронирований</h4>
            <p class="text-muted">
              Начните использовать систему, забронировав свою первую аудиторию
            </p>
            <a href="{{ url_for('main.booking') }}" class="btn btn-success btn-lg">
              <i class="fas fa-calendar-plus me-2"></i>Забронировать аудиторию
            </a>
          </div>
          {% endif %}
        </div>
      </div>
    </div>
  </div>
</div>

<style>
  /* Стили для профиля */
  .user-info-item {
    padding: 15px;
    background: #f8f9fa;
    border-radius: 10px;
    border-left: 4px solid var(--primary-color);
  }

  .booking-time {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 15px;
    background: linear-gradient(135deg, #f8f9fa, #e9ecef);
    border-radius: 10px;
    margin-bottom: 15px;
  }

  .classroom-icon {
    width: 40px;
    height: 40px;
    background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
  }

  .time-slot {
    display: inline-flex;
    align-items: center;
  }

  .booking-purpose {
    max-width: 200px;
    word-wrap: break-word;
  }

  /* Анимация для активных бронирований */
  @keyframes pulse-green {
    0% {
      box-shadow: 0 0 0 0 rgba(40, 167, 69, 0.7);
    }
    70% {
      box-shadow: 0 0 0 10px rgba(40, 167, 69, 0);
    }
    100% {
      box-shadow: 0 0 0 0 rgba(40, 167, 69, 0);
    }
  }

  .pulse-green {
    animation: pulse-green 2s infinite;
  }

  /* Стили для фильтров */
  .filter-btn.active {
    background: var(--primary-color);
    color: white;
    border-color: var(--primary-color);
  }
</style>

<script>
  // Фильтрация бронирований
  document.addEventListener('DOMContentLoaded', function () {
    // Инициализация тултипов
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
      return new bootstrap.Tooltip(tooltipTriggerEl);
    });

    // Фильтрация таблицы
    const filterBtns = document.querySelectorAll('.filter-btn');
    const tableRows = document.querySelectorAll('tbody tr');

    filterBtns.forEach((btn) => {
      btn.addEventListener('click', function () {
        // Удаляем активный класс у всех кнопок
        filterBtns.forEach((b) => b.classList.remove('active'));
        // Добавляем активный класс текущей кнопке
        this.classList.add('active');

        const filter = this.dataset.filter;

        tableRows.forEach((row) => {
          let show = true;

          if (filter === 'approved') {
            show = row.querySelector('.badge.bg-success, .badge.bg-info') !== null;
          } else if (filter === 'pending') {
            show = row.querySelector('.badge.bg-warning') !== null;
          } else if (filter === 'completed') {
            show = row.querySelector('.badge.bg-secondary') !== null;
          } else if (filter === 'today') {
            show = row.querySelector('.badge.bg-info') !== null;
          }
          // 'all' - показываем все

          row.style.display = show ? '' : 'none';
        });
      });
    });

    // Автообновление прогресс-баров каждую минуту
    setInterval(() => {
      const progressBars = document.querySelectorAll('.progress-bar.bg-success');
      progressBars.forEach((bar) => {
        const row = bar.closest('.card');
        if (row) {
          // Можно добавить логику для пересчета прогресса
          bar.classList.add('progress-animated');
          setTimeout(() => bar.classList.remove('progress-animated'), 1000);
        }
      });
    }, 60000);
  });
</script>
{% endblock %}
