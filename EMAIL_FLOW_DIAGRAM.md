# Email Flow Диаграмма

## 📊 Поток отправки email в системе бронирования

```
┌─────────────────────────────────────────────────────────────────┐
│                    СИСТЕМА БРОНИРОВАНИЯ                          │
└─────────────────────────────────────────────────────────────────┘

┌──────────────────────────────────────────────────────────────────┐
│ СЦЕНАРИЙ 1: Студент пытается забронировать занятую аудиторию    │
└──────────────────────────────────────────────────────────────────┘

   Студент заполняет форму бронирования
              ↓
   Система проверяет доступность аудитории
              ↓
   ❌ Аудитория ЗА́НЯТА
              ↓
   ✅ Добавляем студента в BookingQueue
              ↓
   📧 send_queue_notification_email()
      ├─ Получатель: student@email.com
      ├─ Тема: "Вы в очереди бронирования - Позиция #2"
      ├─ Содержит: номер аудитории, дату/время, позицию
      └─ Отправляется в отдельном потоке (асинхронно)
              ↓
   ✅ Студент видит: "Вы встали в очередь (позиция 2)"
              ↓
   📬 Письмо приходит в email


┌──────────────────────────────────────────────────────────────────┐
│ СЦЕНАРИЙ 2: Оригинальное бронирование отменено                  │
└──────────────────────────────────────────────────────────────────┘

   Преподаватель/админ отменяет бронирование
              ↓
   ✅ Бронирование удаляется из БД
              ↓
   Система ищет первого в очереди ждущего студента
              ↓
   ✅ Нашли! Студент на позиции #1
              ↓
   📧 send_queue_approved_email()
      ├─ Получатель: waiting-student@email.com
      ├─ Тема: "Ваша очередь дошла! Аудитория 42 свободна"
      ├─ Содержит: номер аудитории, дату/время, deadline 1 час
      └─ Отправляется в отдельном потоке (асинхронно)
              ↓
   ✅ Статус студента в очереди: notified = True
              ↓
   📬 Письмо приходит в email (зеленый дизайн)


┌──────────────────────────────────────────────────────────────────┐
│ АРХИТЕКТУРА ОТПРАВКИ EMAIL                                       │
└──────────────────────────────────────────────────────────────────┘

   ┌──────────────┐
   │  routes.py   │  ← Обрабатывает запрос пользователя
   └──────┬───────┘
          │ вызывает
          ↓
   ┌──────────────────────────┐
   │   app/email.py           │  ← Функции отправки
   │  - send_email()          │
   │  - send_queue_...()      │
   └──────────────┬───────────┘
                  │ используется
                  ↓
   ┌──────────────────────────────────────────┐
   │       flask_mail + threading             │  ← Асинхронная отправка
   │  ┌──────────────────────────────────┐   │
   │  │ ФОНОВЫЙ ПОТОК                    │   │
   │  │ ├─ Подключается к SMTP серверу   │   │
   │  │ ├─ Авторизуется                  │   │
   │  │ ├─ Отправляет письмо              │   │
   │  │ └─ Закрывает соединение           │   │
   │  └──────────────────────────────────┘   │
   └──────────────┬───────────────────────────┘
                  │
                  ↓
   ┌──────────────────────────────────────────┐
   │  .env config file                        │  ← Параметры SMTP
   │  MAIL_SERVER=smtp.gmail.com              │
   │  MAIL_PORT=587                           │
   │  MAIL_USERNAME=your@gmail.com            │
   │  MAIL_PASSWORD=xxxx xxxx xxxx xxxx       │
   └──────────────┬───────────────────────────┘
                  │
                  ↓
   ┌──────────────────────────────────────────┐
   │        ИНТЕРНЕТ                          │
   │     smtp.gmail.com:587                   │
   └──────────────┬───────────────────────────┘
                  │
                  ↓
   ┌──────────────────────────────────────────┐
   │    📧 GMAIL / SMTP СЕРВЕР               │
   │  ├─ Проверяет учетные данные             │
   │  ├─ Сохраняет письмо                     │
   │  └─ Отправляет студенту                  │
   └──────────────┬───────────────────────────┘
                  │
                  ↓
   ┌──────────────────────────────────────────┐
   │    ✅ MAILBOX СТУДЕНТА                   │
   │  ├─ "Вы в очереди (позиция #2)"          │
   │  └─ "Ваша очередь дошла!"               │
   └──────────────────────────────────────────┘


┌──────────────────────────────────────────────────────────────────┐
│ ИНФОРМАЦИОННЫЙ ПОТОК                                             │
└──────────────────────────────────────────────────────────────────┘

  👤 Студент Иван          📋 БД: Bookings & BookingQueue
   │                            │
   ├─ Пытается забронировать ───┤─→ Check: аудитория занята?
   │                            │
   │←─ "Встали в очередь #2" ──┤─→ Create: BookingQueue entry
   │                            │
   │←─📧 Письмо об очереди  ───┤─→ Call: send_queue_notification_email()
   │                            │
   │                            │
  👨‍🏫 Преподаватель Петр     │
   │                            │
   ├─ Отменяет бронирование ───┤─→ Delete: Booking record
   │                            │
   │                            │
   │                            │├─→ Find: First waiting in queue
   │                            │
   │                            │├─→ Update: status = 'notified'
   │                            │
   │                            │├─→ Call: send_queue_approved_email()
   │                            │
   │     Иван получает:        │
   ├────📧 "Очередь дошла!" ──┤
   │                            │


┌──────────────────────────────────────────────────────────────────┐
│ ОБРАБОТКА ОШИБОК                                                 │
└──────────────────────────────────────────────────────────────────┘

┌─ Ошибка при отправке email ────┐
│                                  │
├─→ Логируется в консоль           │
│   "Ошибка при отправке email: ..."
│                                  │
├─→ НЕ прерывает процесс           │
│   (система продолжает работу)    │
│                                  │
└─ Студент видит успешную           │
   операцию в UI,                   │
   но письмо не отправилось         │
   (можно проверить в логах)        │


┌──────────────────────────────────────────────────────────────────┐
│ ПРИМЕРЫ ОТПРАВЛЯЕМЫХ ПИСЕМ                                       │
└──────────────────────────────────────────────────────────────────┘

  📧 ПИСЬМО 1: Уведомление об очереди
  ┌────────────────────────────────────┐
  │ From: noreply@booking-system.com   │
  │ To: student@gmail.com              │
  │ Subject: 📋 Вы добавлены в очередь │
  │                                    │
  │ ┌───────────────────────────────┐ │
  │ │ Здравствуйте, Иван!          │ │
  │ │                               │ │
  │ │ Аудитория: 42                 │ │
  │ │ Дата: 05.12.2025             │ │
  │ │ Время: 10:00 - 12:00          │ │
  │ │ Позиция в очереди: #2         │ │
  │ │                               │ │
  │ │ Мы уведомим вас, когда        │ │
  │ │ аудитория освободится!        │ │
  │ └───────────────────────────────┘ │
  └────────────────────────────────────┘

  📧 ПИСЬМО 2: Уведомление об одобрении
  ┌────────────────────────────────────┐
  │ From: noreply@booking-system.com   │
  │ To: student@gmail.com              │
  │ Subject: ✅ Ваша очередь дошла!    │
  │                                    │
  │ ┌───────────────────────────────┐ │
  │ │ Здравствуйте, Иван!          │ │
  │ │                               │ │
  │ │ 🎉 Отличная новость!          │ │
  │ │                               │ │
  │ │ Аудитория: 42                 │ │
  │ │ Дата: 05.12.2025             │ │
  │ │ Время: 10:00 - 12:00          │ │
  │ │                               │ │
  │ │ Аудитория теперь свободна!    │ │
  │ │ Подтвердите в течение 1 часа  │ │
  │ └───────────────────────────────┘ │
  └────────────────────────────────────┘


┌──────────────────────────────────────────────────────────────────┐
│ ОПТИМИЗАЦИЯ                                                      │
└──────────────────────────────────────────────────────────────────┘

✅ Асинхронная отправка
   → Не блокирует пользовательский запрос
   → Письма отправляются в фоновом потоке
   → Быстрый ответ UI пользователю

✅ Обработка ошибок
   → Ошибки не прерывают основной процесс
   → Логируются для отладки

✅ HTML оформление
   → Профессиональный вид
   → Цветовое кодирование (желтое/зеленое)
   → Мобильная адаптивность

✅ Локализация
   → Полностью на русском языке
   → Понятные сообщения

```
